version: 0.2
env:
  variables:
    PIPELINE_STAGE: master

phases:
  install:
    commands:
      - echo "install"

  pre_build:
    commands:
      - echo "pre_build"

  ## Image To Docker & Tagging
  build:
    commands:
      - echo "BUILD NUMBER >> $CODEBUILD_BUILD_NUMBER"
      - echo "ACCOUNT >> $AWS_ACCOUNT"
      - docker build -t web:$CODEBUILD_BUILD_NUMBER .
      - aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin $AWS_ACCOUNT.dkr.ecr.ap-northeast-2.amazonaws.com
      - docker build -t hello-world .
      - docker tag web:$CODEBUILD_BUILD_NUMBER $AWS_ACCOUNT.dkr.ecr.ap-northeast-2.amazonaws.com/hello-world:$PIPELINE_STAGE-$CODEBUILD_BUILD_NUMBER

  ## Upload Docker Registry
  post_build:
    commands:
      - echo "post_build"
      - docker push $AWS_ACCOUNT.dkr.ecr.ap-northeast-2.amazonaws.com/hello-world:$PIPELINE_STAGE-$CODEBUILD_BUILD_NUMBER
